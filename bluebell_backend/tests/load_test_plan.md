# Bluebell论坛压测方案

## 1. 压测场景设计

### 1.1 读操作场景（80%并发）

#### 场景A：首页帖子列表
- **接口**：GET /api/v1/posts?size=10&page=1
- **并发量**：1000-5000 QPS
- **数据量**：测试1万-100万篇帖子
- **Redis验证**：缓存命中率 > 90%

#### 场景B：帖子详情查看
- **接口**：GET /api/v1/post/:id
- **并发量**：2000-10000 QPS
- **数据验证**：详情加载 < 50ms
- **缓存策略**：帖子详情缓存7天

#### 场景C：热门帖子排行
- **接口**：GET /api/v1/posts/hot?days=7
- **并发量**：500-2000 QPS
- **数据量**：7天内帖子投票统计
- **计算复杂度**：实时投票排行

#### 场景D：社区帖子筛选
- **接口**：GET /api/v1/community/:id/posts
- **并发量**：300-1500 QPS
- **数据量**：每个社区帖子数量
- **分页测试**：深度分页性能

### 1.2 写操作场景（20%并发）

#### 场景E：发帖操作
- **接口**：POST /api/v1/post
- **并发量**：100-500 QPS
- **数据验证**：帖子创建 < 200ms
- **缓存同步**：新帖预热机制

#### 场景F：投票操作
- **接口**：POST /api/v1/vote
- **并发量**：500-2000 QPS
- **数据一致性**：投票计数准确性
- **缓存更新**：实时排行更新

#### 场景G：评论操作
- **接口**：POST /api/v1/comment
- **并发量**：200-1000 QPS
- **数据验证**：评论创建 < 100ms
- **通知机制**：评论提醒系统

#### 场景H：用户注册/登录
- **接口**：POST /api/v1/user/login
- **并发量**：50-200 QPS
- **认证性能**：JWT生成验证
- **限流测试**：防止暴力破解

## 2. 性能指标基准

### 2.1 响应时间指标
| 接口类型 | P95响应时间 | P99响应时间 | 目标值 |
|---------|-------------|-------------|--------|
| 读操作 | < 50ms | < 100ms | 优秀 |
| 写操作 | < 200ms | < 500ms | 良好 |
| 登录 | < 100ms | < 300ms | 良好 |

### 2.2 并发能力指标
| 场景 | 目标QPS | 最大并发用户 | 成功率 |
|------|---------|--------------|--------|
| 帖子列表 | 5000 | 10000 | > 99.9% |
| 帖子详情 | 10000 | 20000 | > 99.9% |
| 发帖 | 500 | 1000 | > 99% |
| 投票 | 2000 | 5000 | > 99% |

### 2.3 资源使用指标
- **CPU使用率**：< 70%
- **内存使用率**：< 80%
- **Redis命中率**：> 90%
- **数据库连接池**：< 80%

## 3. 压测工具选择

### 3.1 工具推荐
- **wrk**：HTTP基准测试
- **locust**：Python分布式压测
- **JMeter**：可视化压测
- **go-wrk**：Go语言专用

### 3.2 数据准备脚本
```bash
# 生成测试数据
./scripts/generate_test_data.sh --users 10000 --posts 100000 --votes 500000

# 预热Redis缓存
./scripts/warmup_tool --full
```

## 4. 压测执行计划

### 4.1 阶段1：单机压测（1小时）
- **目标**：验证单机性能瓶颈
- **并发**：100-1000用户
- **监控**：CPU、内存、响应时间

### 4.2 阶段2：集群压测（4小时）
- **目标**：验证系统整体承载能力
- **并发**：1000-10000用户
- **监控**：负载均衡、缓存命中率

### 4.3 阶段3：长时间稳定性测试（24小时）
- **目标**：验证系统稳定性
- **并发**：50%最大负载
- **监控**：内存泄露、连接池

## 5. 监控告警

### 5.1 实时监控指标
- **QPS/TPS** 趋势图
- **响应时间** 分布图
- **错误率** 统计
- **资源使用率** 监控

### 5.2 告警规则
- 响应时间 > 1秒
- 错误率 > 1%
- CPU使用率 > 80%
- 内存使用率 > 85%

## 6. 预期瓶颈分析

### 6.1 可能瓶颈点
1. **Redis连接数**：高并发下连接池耗尽
2. **数据库查询**：复杂SQL查询性能
3. **缓存雪崩**：大量缓存同时失效
4. **投票计数**：实时排行计算

### 6.2 优化预案
- **连接池调优**：增加Redis连接池大小
- **SQL优化**：添加复合索引
- **缓存策略**：多级缓存+随机过期时间
- **异步处理**：投票计数异步更新

## 7. 压测报告模板

### 7.1 报告内容
- 测试环境说明
- 性能指标达成情况
- 瓶颈点分析
- 优化建议
- 风险评估

### 7.2 关键结论
- 最大承载QPS
- 推荐服务器配置
- 缓存策略效果
- 扩容建议